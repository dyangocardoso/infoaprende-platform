name: E2E Playwright

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    name: Ejecutar E2E Playwright
    runs-on: ubuntu-latest
    env:
      BACKEND_PORT: "4000" # Ajusta si tu backend usa otro puerto en CI
      FRONTEND_PORT: "5173" # Ajusta si tu frontend usa otro puerto en CI
      PLAYWRIGHT_TRACE: "on-first-retry" # Opciones: off, on, on-first-retry, retain-on-failure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install backend dependencies
        run: npm ci --prefix backend

      - name: Install frontend dependencies
        run: npm ci --prefix frontend

      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps

      - name: Start backend (background)
        run: |
          npm --prefix backend run dev > backend.log 2>&1 &
          echo $! > backend.pid

      - name: Start frontend (background)
        run: |
          npm --prefix frontend run dev > frontend.log 2>&1 &
          echo $! > frontend.pid

      - name: Wait for backend /api/health
        run: |
          for i in {1..60}; do
            if curl -sSf http://localhost:${BACKEND_PORT}/api/health >/dev/null; then
              echo "backend ready"; break
            fi
            echo "waiting for backend... ($i)"; sleep 2
          done

      - name: Wait for frontend (root)
        run: |
          for i in {1..60}; do
            if curl -sSf http://localhost:${FRONTEND_PORT}/ >/dev/null; then
              echo "frontend ready"; break
            fi
            echo "waiting for frontend... ($i)"; sleep 2
          done

      - name: Run Playwright E2E tests
        env:
          CI: true
        run: npx playwright test --reporter=list,html --trace ${PLAYWRIGHT_TRACE}

      - name: List generated Playwright artifacts
        if: always()
        run: |
          echo "== playwright-report contents =="
          if [ -d playwright-report ]; then ls -la playwright-report || true; else echo "playwright-report not found"; fi
          echo "\n== test-results contents =="
          if [ -d test-results ]; then ls -la test-results || true; else echo "test-results not found"; fi
          echo "\n== sizes =="
          du -sh playwright-report || true
          du -sh test-results || true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: |
            backend.log
            frontend.log

      - name: Stop servers
        if: always()
        run: |
          if [ -f backend.pid ]; then kill "$(cat backend.pid)" || true; fi
          if [ -f frontend.pid ]; then kill "$(cat frontend.pid)" || true; fi
          sleep 1 || true
